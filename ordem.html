<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Ordem de Coleta</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      border: 1px solid #000;
      padding: 15px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      width: 210mm;
      min-height: 297mm;
      box-sizing: border-box;
    }

    .header-qr-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    #headerQrCode {
      width: 70px;
      height: 70px;
      background: white;
      padding: 5px;
      border: 1px solid #ddd;
    }

    .logo-cell {
      width: 20%;
      height: 120px;
      padding: 5px;
      position: relative;
    }
    
    .logo-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #eee;
    }
    
    .logo {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      padding: 5px;
      box-sizing: border-box;
    }

    .empresa-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 100;
    }
    
    .empresa-select {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      font-size: 12px;
    }

    input, select, textarea {
      width: 100%;
      border: none;
      background: none;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    td, th {
      border: 1px solid #000;
      padding: 6px;
      vertical-align: top;
    }

    .remetente-destinatario {
      display: flex;
      gap: 15px;
      margin: 15px 0;
    }

    .bloco {
      flex: 1;
      border: 1px solid #000;
      padding: 10px;
    }

    .action-buttons {
      margin-top: 20px;
      text-align: center;
    }
    
    .action-buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
    }
    
    #btnImprimir {
      background: #2196F3;
      color: white;
    }
    
    #btnLimpar {
      background: #f44336;
      color: white;
    }

    .btn-buscar {
      padding: 2px 8px;
      margin-left: 5px;
      font-size: 11px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .no-print {
      display: inline-block;
    }

    /* Modal de visualização do PDF */
    .modal-pdf {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    .modal-content {
      margin: 20px auto;
      display: block;
      width: 90%;
      max-width: 800px;
      height: 85vh;
      border: none;
      background: #000;
    }

    .close {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }

    .modal-buttons {
      text-align: center;
      margin: 20px 0;
      position: relative;
      z-index: 1001;
    }

    .modal-buttons button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }

    #btnSalvarPDF {
      background: #2196F3;
      color: white;
    }

    #btnImprimirPDF {
      background: #4CAF50;
      color: white;
    }

    @media print {
      body, html {
        width: 210mm;
        height: 297mm;
        margin: 0 !important;
        padding: 0 !important;
        background: white;
      }
      .no-print, .action-buttons, .empresa-selector, .btn-buscar {
        display: none !important;
      }
      .logo-container {
        border: none !important;
      }
      .container {
        border: none;
        box-shadow: none;
        padding: 5mm;
        margin: 0;
        width: 100%;
        min-height: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="empresa-selector no-print">
    <select id="empresa-select" class="empresa-select" onchange="trocarEmpresa()">
      <option value="RODOVAR">RODOVAR</option>
      <option value="AXD">AXD</option>
    </select>
  </div>

  <div class="container" id="containerPDF">
    <table>
      <tr>
        <td class="logo-cell" rowspan="3">
          <div class="logo-container">
            <img id="logotipo" class="logo" src="logo_rodovar.png" alt="Logotipo RODOVAR" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTUwIDEwMCI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlZWVlZWUiLz48dGV4dCB4PSI3NSIgeT0iNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+TG9nb3RpcG8gbmFvIGVuY29udHJhZG88L3RleHQ+PC9zdmc+'">
          </div>
        </td>
        <td colspan="2" id="empresa-info">
          RODOVAR LTDA<br>
          CNPJ: 49.908.710/0001-03<br>
          Insc. Estadual: 228.253.729 ME<br>
          Travessa Acalanto, 84 - Jardim das Margaridas<br>
          Salvador - BA
        </td>
        <td colspan="2">
          <div class="header-qr-container">
            <div id="headerQrCode"></div>
            <div style="text-align: center;">
              <h2 style="margin: 0; font-size: 18px;">Ordem de Coleta</h2>
              <div id="numeroOrdem" style="font-weight: bold;">OC231201-0524</div>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2"></td>
        <td>Data emissão:<br><input type="datetime-local" id="dataEmissao"></td>
        <td></td>
      </tr>
      <tr>
        <td>Operador:<br><input type="text" id="operador" value="MARIANE"></td>
        <td>Número:<br><input type="text" id="inputNumero" value="OC231201-0524"></td>
        <td colspan="2"></td>
      </tr>
    </table>

    <div class="remetente-destinatario">
      <div class="bloco">
        <h3 style="margin: 0 0 10px 0; text-align: center;">Remetente</h3>
        <input type="text" id="remetenteNome" value="SEQUIOA MADEIREIRA LTDA">
        <input type="text" id="remetenteCNPJ" value="28.199.101/0001-52">
        
        <div style="margin-top: 10px;">
          <input type="text" id="remetenteCEP" placeholder="CEP" value="41500-300" 
                 style="width: 100px; display: inline-block;">
          <button class="btn-buscar no-print" onclick="buscarCEP('remetente')">Buscar</button>
        </div>
        
        <div id="remetenteEndereco" style="margin-top: 5px;">
          Rua das Flores, 123 - Centro
        </div>
        <div style="margin-top: 5px;">
          <input type="text" id="remetenteCidade" value="Salvador" style="width: 70%; display: inline-block;">
          <select id="remetenteUF" style="width: 25%;">
            <option value="BA" selected>BA</option>
          </select>
        </div>
      </div>

      <div class="bloco">
        <h3 style="margin: 0 0 10px 0; text-align: center;">Destinatário</h3>
        <input type="text" id="destinatarioNome" placeholder="Nome do Destinatário">
        <input type="text" id="destinatarioCNPJ" placeholder="CNPJ/CPF">
        
        <div style="margin-top: 10px;">
          <input type="text" id="destinatarioCEP" placeholder="CEP" 
                 style="width: 100px; display: inline-block;">
          <button class="btn-buscar no-print" onclick="buscarCEP('destinatario')">Buscar</button>
        </div>
        
        <div id="destinatarioEndereco" style="margin-top: 5px;"></div>
        <div style="margin-top: 5px;">
          <input type="text" id="destinatarioCidade" placeholder="Cidade" style="width: 70%; display: inline-block;">
          <select id="destinatarioUF" style="width: 25%;">
            <option value="BA">BA</option>
          </select>
        </div>
      </div>
    </div>

    <table>
      <tr>
        <th colspan="5">Produto</th>
        <th>Espécie</th>
        <th>Peso Unit.</th>
        <th>Peso Bruto</th>
      </tr>
      <tr>
        <td colspan="5"><input type="text" id="produtoDescricao" value="CHAPAS DE MADEIRA"></td>
        <td>
          <select id="especie">
            <option value="">Selecione</option>
            <option value="Palete">Palete</option>
            <option value="Caixaria">Caixaria</option>
            <option value="Tambor">Tambor</option>
            <option value="Unidade">Unidade</option>
            <option value="Sacaria">Sacaria</option>
            <option value="Pacote">Pacote</option>
            <option value="Mobília">Mobília</option>
            <option value="Container">Container</option>
            <option value="Bobina">Bobina</option>
            <option value="Granel">Granel</option>
            <option value="Outros">Outros</option>
          </select>
        </td>
        <td><input type="text" id="pesoUnitario" value="0,00"></td>
        <td><input type="text" id="pesoBruto" value="0,00"></td>
      </tr>
    </table>

    <table>
      <tr>
        <th style="width: 60%;">Destino</th>
        <th>Quantidade</th>
        <th>Pedido</th>
      </tr>
      <tr>
        <td>
          <input type="text" id="destino" value="PORTO DE SAUIPE, MATA DE SAO JOAO-BA">
          <div style="margin-top: 5px;">
            <input type="text" id="destinoCEP" placeholder="CEP do Destino" style="width: 100px;">
            <button class="btn-buscar no-print" onclick="buscarCEP('destino')">Buscar CEP</button>
          </div>
        </td>
        <td><input type="text" id="quantidade" value="0,00"></td>
        <td><input type="text" id="pedido"></td>
      </tr>
    </table>

    <table>
      <tr>
        <th>Observação</th>
      </tr>
      <tr>
        <td><textarea id="observacao" rows="3" style="resize: none;"></textarea></td>
      </tr>
    </table>

    <table>
      <tr>
        <td colspan="3">Motorista: <input type="text" id="motoristaNome" value="GENIVAL FUIZA DOS SANTOS"></td>
        <td>CPF: <input type="text" id="motoristaCPF" value="007.461.998-56"></td>
        <td>RG: <input type="text" id="motoristaRG" value="1300242795"></td>
        <td>CNH: <input type="text" id="motoristaCNH" value="88683744664"></td>
      </tr>
      <tr>
        <td>Veículo: 
          <select id="veiculo">
            <option value="">Selecione</option>
            <option value="Toco">Toco</option>
            <option value="Truck">Truck</option>
            <option value="Bitruck">Bitruck</option>
            <option value="Cavalo Mecânico">Cavalo Mecânico</option>
            <option value="Bitrem">Bitrem</option>
            <option value="Rodotrem">Rodotrem</option>
            <option value="Caminhão baú">Caminhão baú</option>
            <option value="Caminhão Munck">Caminhão Munck</option>
            <option value="Carreta">Carreta</option>
            <option value="Vanderléia">Vanderléia</option>
            <option value="Furgão">Furgão</option>
            <option value="Camionete">Camionete</option>
            <option value="Utilitário">Utilitário</option>
            <option value="Outros">Outros</option>
          </select>
        </td>
        <td>Placa: <input type="text" id="veiculoPlaca" value="AAA0A00"></td>
        <td>Carreta: <input type="text" id="veiculoCarreta"></td>
        <td>Veículo 2: 
          <select id="veiculo2">
            <option value="">Nenhum</option>
            <option value="Toco">Toco</option>
            <option value="Truck">Truck</option>
            <option value="Bitruck">Bitruck</option>
            <option value="Cavalo Mecânico">Cavalo Mecânico</option>
            <option value="Bitrem">Bitrem</option>
            <option value="Rodotrem">Rodotrem</option>
            <option value="Caminhão baú">Caminhão baú</option>
            <option value="Caminhão Munck">Caminhão Munck</option>
            <option value="Carreta">Carreta</option>
            <option value="Vanderléia">Vanderléia</option>
            <option value="Furgão">Furgão</option>
            <option value="Camionete">Camionete</option>
            <option value="Utilitário">Utilitário</option>
            <option value="Outros">Outros</option>
          </select>
        </td>
        <td>Placa 2: <input type="text" id="veiculo2Placa"></td>
        <td>Carreta 2: <input type="text" id="veiculo2Carreta"></td>
      </tr>
    </table>

    <table>
      <tr>
        <td style="height: 50px;">Assinatura do Motorista</td>
        <td>Data:<br><input type="date" id="dataAssinatura"></td>
        <td>Responsável pela Operação</td>
      </tr>
    </table>
  </div>

  <div class="action-buttons no-print">
    <button id="btnImprimir" onclick="visualizarPDF()">
      <i class="fas fa-print"></i> Imprimir/Salvar PDF
    </button>
    <button id="btnLimpar" onclick="limparFormulario()">
      <i class="fas fa-trash-alt"></i> Limpar Formulário
    </button>
  </div>

  <!-- Modal para visualização do PDF -->
  <div id="pdfModal" class="modal-pdf">
    <span class="close" onclick="fecharModal()">&times;</span>
    <div class="modal-buttons">
      <button id="btnSalvarPDF" onclick="salvarPDF()">
        <i class="fas fa-save"></i> Salvar PDF
      </button>
      <button id="btnImprimirPDF" onclick="imprimirPDF()">
        <i class="fas fa-print"></i> Imprimir
      </button>
    </div>
    <iframe id="pdfViewer" class="modal-content"></iframe>
  </div>

  <!-- Bibliotecas necessárias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <script>
    // Variáveis globais
    let numeroOrdem = 524;
    let qrCodeInstance = null;
    let pdfBlob = null;
    let debounceTimer = null;

    // Dados das empresas
    const empresas = {
      AXD: {
        nome: "AXD",
        cnpj: "59.352.973/0001-32",
        ie: "228.253.729 ME",
        endereco: "RUA Jubiabá, 292 - Bairro: Luis Eduardo Magalhães",
        cidade: "Simões Filho",
        uf: "BA",
        logo: "logo_axd.png"
      },
      RODOVAR: {
        nome: "RODOVAR LTDA",
        cnpj: "49.908.710/0001-03",
        ie: "228.253.729 ME",
        endereco: "Travessa Acalanto, 84 - Jardim das Margaridas",
        cidade: "Salvador",
        uf: "BA",
        logo: "logo_rodovar.png"
      }
    };

    // Função para visualizar o PDF
    async function visualizarPDF() {
      // Esconde todos os botões de buscar
      document.querySelectorAll('.btn-buscar').forEach(btn => {
        btn.style.visibility = 'hidden';
      });
      
      // Atualiza o QRCode antes de gerar o PDF
      gerarQRCode();
      
      try {
        const element = document.getElementById('containerPDF');
        const opt = {
          margin: [5, 5, 5, 5],
          filename: `OrdemColeta_${document.getElementById('inputNumero').value}.pdf`,
          image: { type: 'jpeg', quality: 1 },
          html2canvas: { 
            scale: 1.5,
            logging: true,
            useCORS: true,
            allowTaint: true,
            scrollX: 0,
            scrollY: 0,
            width: element.scrollWidth + 20,
            height: element.scrollHeight + 20,
            ignoreElements: (el) => el.classList.contains('btn-buscar')
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true,
            hotfixes: ['px_scaling']
          }
        };

        // Gerar o PDF e obter como blob
        const result = await html2pdf().set(opt).from(element).outputPdf('blob');
        pdfBlob = result;
        
        // Criar URL para o blob
        const url = URL.createObjectURL(result);
        
        // Mostrar no modal
        document.getElementById('pdfViewer').src = url;
        document.getElementById('pdfModal').style.display = 'block';
        
      } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        alert("Erro ao gerar PDF. Verifique o console para detalhes.");
      } finally {
        // Restaura a visibilidade dos botões
        document.querySelectorAll('.btn-buscar').forEach(btn => {
          btn.style.visibility = 'visible';
        });
      }
    }

    // Função para fechar o modal
    function fecharModal() {
      document.getElementById('pdfModal').style.display = 'none';
      if (pdfBlob) {
        URL.revokeObjectURL(document.getElementById('pdfViewer').src);
        pdfBlob = null;
      }
    }

    // Função para salvar o PDF
    function salvarPDF() {
      if (pdfBlob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(pdfBlob);
        link.download = `OrdemColeta_${document.getElementById('inputNumero').value}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        fecharModal();
      }
    }

    // Função para imprimir o PDF
    function imprimirPDF() {
      if (pdfBlob) {
        const url = URL.createObjectURL(pdfBlob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        
        iframe.onload = function() {
          setTimeout(function() {
            iframe.contentWindow.print();
            URL.revokeObjectURL(url);
            document.body.removeChild(iframe);
            fecharModal();
          }, 500);
        };
      }
    }

    // Função para gerar dados do QRCode
    function gerarDadosQRCode() {
      return {
        numeroOrdem: document.getElementById('inputNumero').value,
        dataHora: document.getElementById('dataEmissao').value,
        operador: document.getElementById('operador').value
      };
    }

    // Função para gerar/atualizar o QRCode
    function gerarQRCode() {
      const dados = gerarDadosQRCode();
      const dadosString = JSON.stringify(dados);
      const qrCodeElement = document.getElementById('headerQrCode');
      
      qrCodeElement.innerHTML = '';
      
      try {
        if (qrCodeInstance) {
          qrCodeInstance.clear();
        }
        qrCodeInstance = new QRCode(qrCodeElement, {
          text: dadosString,
          width: 70,
          height: 70,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (e) {
        console.error("Erro ao gerar QRCode:", e);
        qrCodeElement.innerHTML = "Erro no QRCode";
      }
    }

    // Função para trocar empresa
    function trocarEmpresa() {
      const empresaSelecionada = document.getElementById('empresa-select').value;
      const empresa = empresas[empresaSelecionada];
      const empresaInfo = document.getElementById('empresa-info');
      const logotipo = document.getElementById('logotipo');

      empresaInfo.innerHTML = `
        ${empresa.nome}<br>
        CNPJ: ${empresa.cnpj}<br>
        Insc. Estadual: ${empresa.ie}<br>
        ${empresa.endereco}<br>
        ${empresa.cidade} - ${empresa.uf}
      `;
      
      logotipo.src = empresa.logo;
      logotipo.alt = `Logotipo ${empresa.nome}`;
      
      gerarQRCode();
    }

    // Função para limpar formulário - VERSÃO COMPLETA
    function limparFormulario() {
      if (confirm('Tem certeza que deseja limpar TODOS os dados?')) {
        // Incrementa e gera novo número de ordem
        numeroOrdem++;
        const novoNumero = gerarNumeroOrdem();
        document.getElementById('inputNumero').value = novoNumero;
        document.getElementById('numeroOrdem').textContent = novoNumero;
        
        // Lista COMPLETA de todos os campos editáveis
        const camposParaLimpar = [
          'remetenteNome', 'remetenteCNPJ', 'remetenteCEP', 'remetenteCidade',
          'destinatarioNome', 'destinatarioCNPJ', 'destinatarioCEP', 'destinatarioCidade',
          'produtoDescricao', 'pesoUnitario', 'pesoBruto', 
          'destino', 'destinoCEP', 'quantidade', 'pedido', 'observacao',
          'motoristaNome', 'motoristaCPF', 'motoristaRG', 'motoristaCNH',
          'veiculoPlaca', 'veiculoCarreta', 'veiculo2Placa', 'veiculo2Carreta'
        ];
        
        // Limpa todos os campos
        camposParaLimpar.forEach(id => {
          const element = document.getElementById(id);
          if (element) element.value = '';
        });
        
        // Limpa endereços
        document.getElementById('destinatarioEndereco').innerText = '';
        document.getElementById('remetenteEndereco').innerText = '';
        
        // Reseta todos os selects
        document.getElementById('especie').selectedIndex = 0;
        document.getElementById('veiculo').selectedIndex = 0;
        document.getElementById('veiculo2').selectedIndex = 0;
        document.getElementById('remetenteUF').value = 'BA';
        document.getElementById('destinatarioUF').value = 'BA';
        
        // Restaura data/hora
        document.getElementById('dataEmissao').value = getDateTimeNow();
        document.getElementById('dataAssinatura').value = getDateNow();
        
        // Atualiza QRCode
        gerarQRCode();
      }
    }

    // Função para buscar CEP
    async function buscarCEP(tipo) {
      const cepInput = document.getElementById(tipo + 'CEP');
      let cep = cepInput.value.replace(/\D/g, '');
      
      if (cep.length !== 8) {
        alert('CEP inválido! Deve conter 8 dígitos.');
        return;
      }
      
      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        
        if (data.erro) {
          throw new Error('CEP não encontrado');
        }
        
        if (tipo !== 'destino') {
          document.getElementById(tipo + 'Endereco').innerText = 
            `${data.logradouro || ''} ${data.complemento || ''} - ${data.bairro || ''}`;
          document.getElementById(tipo + 'Cidade').value = data.localidade || '';
          document.getElementById(tipo + 'UF').value = data.uf || '';
        } else {
          document.getElementById('destino').value = 
            `${data.logradouro || ''}, ${data.bairro || ''}, ${data.localidade || ''} - ${data.uf || ''}`;
        }
        
        gerarQRCode();
      } catch (error) {
        alert('Erro ao buscar CEP: ' + error.message);
      }
    }

    // Função para carregar estados
    async function carregarEstados() {
      try {
        const response = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados');
        const estados = await response.json();
        
        const selectRemetente = document.getElementById('remetenteUF');
        const selectDestinatario = document.getElementById('destinatarioUF');
        
        estados.sort((a, b) => a.nome.localeCompare(b.nome));
        
        estados.forEach(estado => {
          const option = document.createElement('option');
          option.value = estado.sigla;
          option.textContent = estado.sigla;
          
          selectRemetente.appendChild(option.cloneNode(true));
          selectDestinatario.appendChild(option.cloneNode(true));
        });
      } catch (error) {
        console.error('Erro ao carregar estados:', error);
      }
    }

    // Funções auxiliares
    function getDateTimeNow() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      return now.toISOString().slice(0, 16);
    }

    function getDateNow() {
      return new Date().toISOString().slice(0, 10);
    }

    function gerarNumeroOrdem() {
      const data = new Date();
      const ano = data.getFullYear().toString().slice(-2);
      const mes = (data.getMonth() + 1).toString().padStart(2, '0');
      const dia = data.getDate().toString().padStart(2, '0');
      return `OC${ano}${mes}${dia}-${numeroOrdem.toString().padStart(4, '0')}`;
    }

    function formatarCEP(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
      }
      e.target.value = value;
    }

    // Inicialização
    window.onload = function() {
      // Configura data/hora
      document.getElementById('dataEmissao').value = getDateTimeNow();
      document.getElementById('dataAssinatura').value = getDateNow();
      
      // Carrega estados
      carregarEstados();
      
      // Configura eventos para atualizar QRCode
      document.getElementById('inputNumero').addEventListener('change', gerarQRCode);
      document.getElementById('dataEmissao').addEventListener('change', gerarQRCode);
      document.getElementById('operador').addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(gerarQRCode, 500);
      });
      
      // Configura eventos de CEP
      document.querySelectorAll('input[id$="CEP"]').forEach(input => {
        input.addEventListener('input', formatarCEP);
      });

      // Gera QRCode inicial
      gerarQRCode();
    };
  </script>
</body>
</html>
